@using ConstructionDiary.ResourceFiles;
@using ConstructionDiary.Models;
@{
    ViewBag.Title = "Site";
}

@{
    ConstructionDiaryEntities _db = new ConstructionDiaryEntities();
    Guid ClientId = new Guid(clsSession.ClientID.ToString());

}

<section class="wrapper site-min-height">
    <div class="row">

        <div class="col-lg-12 col-sm-12">
            <div class="panel panel-primary" style="opacity: 1;">
                <div class="panel-heading text-center" style="background-color:#3c8bb9; border-color: #3c8bb9;">
                    <strong> @ViewBag.SiteName </strong>
                </div>
            </div>
        </div>

        <div class="col-lg-12">

            <section class="panel">
                <header class="panel-heading">
                    <strong>@Resource.AddNewBill </strong>
                    <a href="/admin/site/newbill/@ViewBag.SiteId" class="btn btn-warning" style="float: right; top: -5px; position: relative;">
                        <i class="fa fa-backward"></i> Back
                    </a>
                </header>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-4 form-group">
                            <label for="BillDate">@Resource.BillDate</label><span class="required">*</span>
                            <input class="form-control default-date-picker" id="BillDate" name="BillDate" placeholder="DD/MM/YYYY" readonly="readonly" type="text">

                            <span id="spn_BillDate" class="field-validation-valid text-danger"></span>
                        </div>

                        <div class="col-sm-4 form-group">
                            <label for="BillNo">@Resource.BillNo</label>
                            <input class="form-control" id="BillNo" name="BillNo" placeholder="@Resource.BillNo" type="text" value="">
                        </div>

                        <div class="col-sm-4 form-group">
                            <label for="Remarks">@Resource.Remarks</label>
                            <input class="form-control" id="Remarks" name="Remarks" placeholder="@Resource.Remarks" type="text" value="">
                        </div>

                    </div>

                </div>
            </section>

            <section class="panel">
                <header class="panel-heading">
                    <strong> @Resource.ItemInfo </strong>
                </header>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-12 form-group">
                            <table class="table table-striped table-hover" id="tbl_PurchaseItem">
                                <thead>
                                    <tr>
                                        <th width="3%">#</th>
                                        <th width="8%"></th>
                                        <th>@Resource.ItemName</th>
                                        <th width="8%">@Resource.Type</th>
                                        <th width="8%">@Resource.Length</th>
                                        <th width="8%">@Resource.Height</th>
                                        <th width="8%">@Resource.Width</th>
                                        <th width="8%">@Resource.Qty</th>
                                        <th width="10%">@Resource.Area</th>
                                        <th width="8%">@Resource.Rate</th>
                                        <th width="10%">@Resource.Amount</th>
                                        <th width="3%"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{ Guid newId = Guid.NewGuid(); }
                                    <tr id="@newId">
                                        <td>1</td>
                                        <td>
                                            <select class="form-control clsCategory" id="Category_@newId" name="Category_@newId"> 
                                                <option value="add">Add</option>
                                                <option value="less">Less</option>
                                            </select> 
                                        </td>
                                        <td>
                                            <input class="form-control clsItemName" id="ItemName_@newId" name="ItemName_@newId" placeholder="@Resource.ItemName" type="text">
                                            <span id="spn_ItemName_@newId" class="field-validation-valid text-danger"></span>
                                        </td>
                                        <td>
                                            <select class="form-control clsItemType" id="ItemType_@newId" name="ItemType_@newId">
                                                <option value="">-@Resource.Type-</option>
                                                <option value="cft">CFT</option>
                                                <option value="sft">SFT</option>
                                                <option value="rft">RFT</option>
                                                <option value="nos">NOS</option>
                                            </select>
                                            <span id="spn_ItemType_@newId" class="field-validation-valid text-danger"></span>
                                        </td>
                                        <td>
                                            <input class="form-control clsLength" id="Length_@newId" name="Length_@newId" placeholder="@Resource.Length" type="text" disabled>
                                            <span id="spn_Length_@newId" class="field-validation-valid text-danger"></span>
                                        </td>
                                        <td>
                                            <input class="form-control clsHeight" id="Height_@newId" name="Height_@newId" placeholder="@Resource.Height" type="text" disabled>
                                            <span id="spn_Height_@newId" name="spn_Height_@newId" class="field-validation-valid text-danger"></span>
                                        </td>
                                        <td>
                                            <input class="form-control clsWidth" id="Width_@newId" name="Width_@newId" placeholder="@Resource.Width" type="text" disabled>
                                            <span id="spn_Width_@newId" name="spn_Width_@newId" class="field-validation-valid text-danger"></span>
                                        </td>
                                        <td>
                                            <input class="form-control clsQty" id="Qty_@newId" name="Qty_@newId" placeholder="@Resource.Qty" type="text" disabled>
                                            <span id="spn_Qty_@newId" name="spn_Qty_@newId" class="field-validation-valid text-danger"></span>
                                        </td>
                                        <td>
                                            <span id="Area_@newId">0</span>
                                        </td>
                                        <td>
                                            <input class="form-control clsRate" id="Rate_@newId" name="Rate_@newId" placeholder="@Resource.Rate" type="text" disabled>
                                            <span id="spn_Rate_@newId" name="spn_Rate_@newId" class="field-validation-valid text-danger"></span>
                                        </td>
                                        <td>
                                            <span id="ItemAmount_@newId">0</span>
                                        </td>
                                        <td>
                                            <button title="Delete" delete-id="@newId" class="btn btn-round btn-danger clsDelete" type="button" style="display:none;"><i class="fa fa-trash-o"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="10">
                                            <button id="btnAddItem" class="btn btn-round btn-success pull-right" type="button"><i class="fa fa-plus"></i> Add Item</button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-4 invoice-block pull-right">
                            <ul class="unstyled amounts">
                                <li><strong>@Resource.SubTotalAmount : </strong> <span id="lblSubTotal">0</span></li>
                                <li>
                                    <strong>@Resource.AdjustmentAmount : </strong>
                                    <input class="form-control" id="AdjustmentAmount" name="AdjustmentAmount" placeholder="" type="number">
                                    <span id="AdjustmentAmount" class="field-validation-valid text-danger"></span>
                                </li>
                                <li>
                                    <strong>@Resource.GrandTotal : </strong> <span id="lblGrandTotal">0</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12 form-group">
                            <button class="btn btn-success" id="btnSubmitBill" type="button">@Resource.Save</button>
                            <a href="/admin/site/newbill/@ViewBag.SiteId" class="btn btn-default">@Resource.Cancel</a>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</section>

<script src="~/Areas/Admin/Content/js/jquery.js"></script>
<script>

    var materialList = "";
    var dateObj = new Date();
    var month = dateObj.getUTCMonth() + 1; //months from 1-12
    var day = dateObj.getUTCDate();
    var year = dateObj.getUTCFullYear();
    var newdate = (day < 10 ? '0' + day : '' + day) + "/" + (month < 10 ? '0' + month : '' + month) + "/" + year;
    var field_required_msg = '@Resource.Required';

    jQuery("#BillDate").val(newdate);

    jQuery(document).ready(function () {
        jQuery('html, body').animate({ scrollTop: 0 }, 1000);
    });

    function ReArrangeIndex() {
        var index = 1;
        $("#tbl_PurchaseItem tbody tr").each(function () {
            $(this).find("td:first").text(index);
            index++;
        });
    }

    var ItemTypeOptionList = "<option value=''>-@Resource.Type-</option> <option value='cft'>CFT</option> <option value='sft'>SFT</option> <option value='rft'>RFT</option> <option value='nos'>NOS</option>";

    $(document).on("click", "#btnAddItem", function () {

        var nextIndex = $("#tbl_PurchaseItem tbody tr").length + 1;
        var newGuid = uuid();

        var htmlData = "<tr id='" + newGuid + "'>";
        htmlData += "<td>" + nextIndex + "</td>";

        htmlData += "<td><select class='form-control clsCategory' id='Category_" + newGuid + "' name='Category_" + newGuid + "'><option value='add'>Add</option><option value='less'>Less</option></select></td>";

        htmlData += "<td><input class='form-control clsItemName' id='ItemName_" + newGuid + "' placeholder='@Resource.ItemName' type='text'> <span id='spn_ItemName_" + newGuid + "' class='field-validation-valid text-danger'></span></td>";

        htmlData += "<td> <select class='form-control clsItemType' id='ItemType_" + newGuid + "' name='ItemType_" + newGuid + "'> " + ItemTypeOptionList + " </select> <span id='spn_ItemType_" + newGuid + "' class='field-validation-valid text-danger'></span> </td>";

        htmlData += "<td><input class='form-control clsLength' id='Length_" + newGuid + "' placeholder='@Resource.Length' type='text' disabled> <span id='spn_Length_" + newGuid + "' class='field-validation-valid text-danger'></span></td>";

        htmlData += "<td><input class='form-control clsHeight' id='Height_" + newGuid + "' placeholder='@Resource.Height' type='text' disabled> <span id='spn_Height_" + newGuid + "' class='field-validation-valid text-danger'></span></td>";

        htmlData += "<td><input class='form-control clsWidth' id='Width_" + newGuid + "' placeholder='@Resource.Width' type='text' disabled> <span id='spn_Width_" + newGuid + "' class='field-validation-valid text-danger'></span></td>";

        htmlData += "<td><input class='form-control clsQty' id='Qty_" + newGuid + "' placeholder='@Resource.Qty' type='text' disabled> <span id='spn_Qty_" + newGuid + "' class='field-validation-valid text-danger'></span></td>";

        htmlData += "<td> <span id='Area_" + newGuid + "'>0</span> </td>";

        htmlData += "<td><input class='form-control clsRate' id='Rate_" + newGuid + "' placeholder='@Resource.Rate' type='text' disabled> <span id='spn_Rate_" + newGuid + "' class='field-validation-valid text-danger'></span></td>";

        htmlData += "<td><span id='ItemAmount_" + newGuid + "'>0</span></td>";

        htmlData += "<td><button title='Delete' delete-id='" + newGuid + "' class='btn btn-round btn-danger clsDelete' type='button'><i class='fa fa-trash-o'></i></button></td>";

        htmlData += "</tr>";

        $("tbody").append(htmlData);

        //
        var itemscount = $("#tbl_PurchaseItem tbody tr").length;
        if (itemscount > 1)
            $("#tbl_PurchaseItem tbody tr .clsDelete").show();

    });

    function uuid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
        });
    }

    function UpdateValues() {

        var subTotal = 0;
        var cgst = 0;
        var sgst = 0;
        var grandTotal = 0;
        $("#tbl_PurchaseItem tbody tr").each(function () {
            var value = $(this).find("td:eq(4) span").text();
            if (value && value != undefined) {
                subTotal += parseFloat(value);
            }
        });

        var GST_Per = $("#GST_Per").val();
        if (GST_Per && GST_Per != "") {
            var gst = GST_Per / 2;
            cgst = (subTotal * gst) / 100;
            sgst = (subTotal * gst) / 100;
        }

        grandTotal = subTotal + cgst + sgst;

        $("#lblCGST").text(cgst);
        $("#lblSGST").text(sgst);
        $("#lblSubTotal").text(subTotal);

        var AdjustmentAmt = $("#AdjustmentAmount").val();
        if (AdjustmentAmt == "" || AdjustmentAmt == undefined || AdjustmentAmt == NaN) {
            AdjustmentAmt = 0;
        }
        grandTotal += parseFloat(AdjustmentAmt);
        $("#lblGrandTotal").text(grandTotal);
    }

    $(document).on("click", ".clsDelete", function () {
        var itemId = $(this).attr("delete-id");
        $("tr#" + itemId).remove();

        var itemscount = $("#tbl_PurchaseItem tbody tr").length;
        if (itemscount == 1)
            $("#tbl_PurchaseItem tbody tr:first .clsDelete").hide();

        ReArrangeIndex();

        // Get all totals
        UpdateValues();
    });

    $(document).on("click", "#btnSubmitBill", function () {
        var isvalid = true;

        var BillDate = $("#BillDate").val();
        var GST_Per = $("#GST_Per").val();
        var SiteId = $("#SiteId").val();
        var MerchantId = $("#MerchantId").val();
        var Remarks = $("#Remarks").val();
        var AdjustmentAmount = $("#AdjustmentAmount").val();

        if (IsEmptyOrNull(BillDate)) {
            $("#spn_BillDate").text(field_required_msg);
            $("#spn_BillDate").show();
            isvalid = false;
        }
        else {
            $("#spn_BillDate").hide();
        }


        if (IsEmptyOrNull(SiteId)) {
            $("#spn_SiteId").text(field_required_msg);
            $("#spn_SiteId").show();
            isvalid = false;
        }
        else {
            $("#spn_SiteId").hide();
        }

        if (IsEmptyOrNull(MerchantId)) {
            $("#spn_MerchantId").text(field_required_msg);
            $("#spn_MerchantId").show();
            isvalid = false;
        }
        else {
            $("#spn_MerchantId").hide();
        }

        // Validations for Items
        $("#tbl_PurchaseItem tbody tr").each(function () {

            var field_id = $(this).attr("id");

            var material_value = $("#MaterialTypeId_" + field_id).val();
            if (IsEmptyOrNull(material_value)) {
                $("#spn_MaterialTypeId_" + field_id).text(field_required_msg);
                $("#spn_MaterialTypeId_" + field_id).show();
                isvalid = false;
            }
            else {
                $("#spn_MaterialTypeId_" + field_id).hide();
            }

            // Weight
            var weight_value = $("#Weight_" + field_id).val();
            if (IsEmptyOrNull(weight_value)) {
                $("#spn_Weight_" + field_id).text(field_required_msg);
                $("#spn_Weight_" + field_id).show();
                isvalid = false;
            }
            else {
                $("#spn_Weight_" + field_id).hide();
            }

            // Rate
            var rate_value = $("#Rate_" + field_id).val();
            if (IsEmptyOrNull(rate_value)) {
                $("#spn_Rate_" + field_id).text(field_required_msg);
                $("#spn_Rate_" + field_id).show();
                isvalid = false;
            }
            else {
                $("#spn_Rate_" + field_id).hide();
            }
        });

        if (!isvalid) {
            jQuery('html, body').animate({ scrollTop: 0 }, 1000);
            return false;
        }

        // Create Object
        var PurchaseItems = [];
        $("#tbl_PurchaseItem tbody tr").each(function () {

            var field_id = $(this).attr("id");

            var material_value = $("#MaterialTypeId_" + field_id).val();
            var weight_value = $("#Weight_" + field_id).val();
            var rate_value = $("#Rate_" + field_id).val();

            PurchaseItems.push({
                "PurchaseItemId": null,
                "MaterialTypeId": material_value,
                "Weight": weight_value,
                "Rate" : rate_value
            });

        });

        var PurchasesVM = {
            "MaterialPurchaseId": null,
            "BillDate": BillDate,
            "SiteId": SiteId,
            "MerchantId" : MerchantId,
            "Remarks": Remarks,
            "GST_Per": GST_Per,
            "AdjustmentAmount": AdjustmentAmount,
            "PurchaseItem": PurchaseItems,
        };

        // Save
        //StartLoading();
        var URL = '@Url.Action("SavePurchase", "Material")';
        $.ajax({
            type: 'POST',
            async: true,
            url: URL,
            data: {
                Purchase : JSON.stringify(PurchasesVM)
            },
            success: function (response) {
                if (response.IsError) {
                alert(response.ErrorMessage);
                //StopLoading();
            }
            else {
                window.location.href = response.RedirectUrl;
            }

            },
            error: function (resultData) {
                alert("error");
                //StopLoading();
            }
        });

    });

    function IsEmptyOrNull(value) {
        if (value == "" || value == undefined || value == NaN)
            return true;
        else
            return false;
    }

    function resetAllValues(id, value)
    {
        $("#Length_" + id).val('');
        $("#Width_" + id).val('');
        $("#Height_" + id).val('');
        $("#Qty_" + id).val('');
        $("#Rate_" + id).val('');

        $("#Area_" + id).text('0 ' + value);
        $("#ItemAmount_" + id).text('0');
    }

    $(document).on("change", ".clsItemType", function () {

        var value = $(this).val();
        var id = $(this).attr("id").split("_")[1];

        resetAllValues(id, value);

        if (value == "") {
            // blank to reset all values

            $("#Length_" + id).prop("disabled", true);
            $("#Width_" + id).prop("disabled", true);
            $("#Height_" + id).prop("disabled", true);
            $("#Qty_" + id).prop("disabled", true);
            $("#Rate_" + id).prop("disabled", true);


        }
        else if (value == "cft") {
            // CFT = Length X Width X Height X Qty = Area X Rate = Amount

            $("#Length_" + id).removeAttr("disabled");
            $("#Width_" + id).removeAttr("disabled");
            $("#Height_" + id).removeAttr("disabled");

            $("#Qty_" + id).removeAttr("disabled");
            $("#Rate_" + id).removeAttr("disabled");

        }
        else if (value == "sft") {
            // SFT = Length X Width X Qty = Area X Rate = Amount

            $("#Length_" + id).removeAttr("disabled");
            $("#Width_" + id).removeAttr("disabled");
            $("#Height_" + id).prop("disabled", true);

            $("#Qty_" + id).removeAttr("disabled");
            $("#Rate_" + id).removeAttr("disabled");

        }
        else if (value == "rft") {
            // RFT = Length X Qty = Area X Rate = Amount

            $("#Length_" + id).removeAttr("disabled");
            $("#Width_" + id).prop("disabled", true);
            $("#Height_" + id).prop("disabled", true);

            $("#Qty_" + id).removeAttr("disabled");
            $("#Rate_" + id).removeAttr("disabled");
        }
        else if (value == "nos") {
            // Nos = Qty = Area X Rate = Amount

            $("#Length_" + id).prop("disabled", true);
            $("#Width_" + id).prop("disabled", true);
            $("#Height_" + id).prop("disabled", true);

            $("#Qty_" + id).removeAttr("disabled");
            $("#Rate_" + id).removeAttr("disabled");
        }
        else {
        }

    });

    $(document).on("keyup", ".clsLength, .clsHeight, .clsWidth, .clsRate, #AdjustmentAmount", function () {

        var id = $(this).attr("id").split("_")[1];
        var type = $("#ItemType_" + id).val();
        var length = $("#Length_" + id).val();
        var height = $("#Height_" + id).val();
        var width = $("#Width_" + id).val();
        var qty = $("#Qty_" + id).val();
        var rate = $("#Rate_" + id).val();

        /* validate start */
        if (IsEmptyOrNull(length))
            length = 0;
        else
            length = parseFloat(length);

        if (IsEmptyOrNull(height))
            height = 0;
        else
            height = parseFloat(height);

        if (IsEmptyOrNull(width))
            width = 0;
        else
            width = parseFloat(width);

        if (IsEmptyOrNull(qty))
            qty = 0;
        else
            qty = parseFloat(qty);

        if (IsEmptyOrNull(rate))
            rate = 0;
        else
            rate = parseFloat(rate);

        /* validate end */

        var area = 0;
        var amount = 0;

        if (type == "cft") {
            area = length * height * width * qty;
        }
        else if (type == "sft") {
            area = length * width * qty;
        }
        else if (type == "rft") {
            area = length * qty;
        }
        else if (type == "nos") {
             area = qty;
        }
        else {
        }
        amount = area * rate;

        $("#Area_" + id).text(parseFloat(area) + " " + type);
        $("#ItemAmount_" + id).text(parseFloat(amount));

        // Get all totals
        UpdateValues();

        return this.value;
    });

</script>